"use strict"; 


function RecordFlat(originRecord, key1, key2, key3) {
        
        var resultCount = 0;
        var resultFinal = [];
        var sourceArray = JSON.parse(originRecord).values;
 
        for ( var i in sourceArray ) {
            var item = sourceArray[i];

            var pointsLengh = item.points.length;
            var lastPointValue = item.points[pointsLengh - 1][1];

            var lastPointTS = item.points[pointsLengh - 1][0];
            var metricsName = item.properties.name; 

            var properties = item.properties;
            delete properties.name;
            properties[metricsName] = lastPointValue;
            properties['LastTS'] = lastPointTS;
            
            //console.log(properties);
            //console.log(item);

            if ( resultFinal.length == 0 ) {
                console.log('the flat record is empty! push a member.');
                resultFinal.push(properties);
                resultCount++;
            }
            else {

                var isFind = false;
                for ( var j in resultFinal) {
                    var resultItem = resultFinal[j];
                    if ( key1 && key2 && key3 ) {
                        if ( resultItem[key1] == properties[key1]  && 
                             resultItem[key2] == properties[key2]  &&
                             resultItem[key3] == properties[key3] 
                            ) {
                            resultItem[metricsName] = lastPointValue;
                            mergeJsonObj(resultItem,properties); 
                            isFind = true;
                        }
                    } else if ( key1 && key2 ) {
                        if ( resultItem[key1] == properties[key1]  && 
                             resultItem[key2] == properties[key2] ) {
                            resultItem[metricsName] = lastPointValue;
                            mergeJsonObj(resultItem,properties); 
                            isFind = true;
                        }
                    } else if ( key1 ) {
                        if ( resultItem[key1] == properties[key1] ) {
                            resultItem[metricsName] = lastPointValue; 
                            mergeJsonObj(resultItem,properties); 
                            
                            isFind = true;
                        }
                    } else {
                        console.log('Must have key values!');
                        return -1;
                    }
                }
                if ( isFind == false ) {
                    resultFinal.push(properties);
                    resultCount++;
                }
                resultFinal['LastTS'] = lastPointTS;
            }

        } 
        console.log("RecordFlat: RecordCount=" + resultCount );
        //response.end(resultFinal);
        return resultFinal;
    };

function mergeJsonObj(target, sources) { 
    for ( var i in sources ) {
        target[i] = sources[i];
    }
    return target;
}


module.exports = RecordFlat;